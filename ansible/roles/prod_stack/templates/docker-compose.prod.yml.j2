services:
  read-db:
    image: postgres:15
    environment:
      POSTGRES_DB: "read"
      POSTGRES_USER: "${DB_USER}"
      POSTGRES_PASSWORD: "${DB_PASSWORD}"
    blkio_config:
      device_read_bps:
        - path: /dev/sda     # Root-Disk deines Hosts
          rate: "20mb"       # z.B. 20 MB/s (anpassen)
      device_read_iops:
        - path: /dev/sda
          rate: 800          # optional
    volumes:
      - read_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d read"]
      interval: 10s
      timeout: 5s
      retries: 5

  storage-db:
    image: timescale/timescaledb:latest-pg15
    environment:
      POSTGRES_DB: "${STORAGE_DB_NAME}"
      POSTGRES_USER: "${STORAGE_DB_USER}"
      POSTGRES_PASSWORD: "${STORAGE_DB_PASSWORD}"
      TIMESCALEDB_TELEMETRY: "${TIMESCALEDB_TELEMETRY}"
    blkio_config:
      device_read_bps:
        - path: /dev/sda     # Root-Disk deines Hosts
          rate: "20mb"       # z.B. 20 MB/s (anpassen)
      device_read_iops:
        - path: /dev/sda
          rate: 800          # optional
    volumes:
      - storage_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${STORAGE_DB_USER} -d ${STORAGE_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

  ingest:
    image: ghcr.io/{{ github_owner | lower }}/meteo-ingest:{{ image_tag | default('prod') }}
    env_file: [ ".env.prod" ]
    environment:
      ASPNETCORE_URLS: "http://0.0.0.0:50051"
    depends_on: [ validation, storage ]
    expose: [ "50051" ]
    restart: unless-stopped

  validation:
    image: ghcr.io/{{ github_owner | lower }}/meteo-validation:{{ image_tag | default('prod') }}
    env_file: [ ".env.prod" ]
    environment:
      ASPNETCORE_URLS: "http://0.0.0.0:50052"
    expose: [ "50052" ]
    restart: unless-stopped

  storage:
    image: ghcr.io/{{ github_owner | lower }}/meteo-storage:{{ image_tag | default('prod') }}
    env_file: [ ".env.prod" ]
    environment:
      ASPNETCORE_URLS: "http://0.0.0.0:50053"
    depends_on: [ storage-db ]
    expose: [ "50053" ]
    restart: unless-stopped

  projection:
    image: ghcr.io/{{ github_owner | lower }}/meteo-projection:{{ image_tag | default('prod') }}
    env_file: [ ".env.prod" ]
    environment:
      ASPNETCORE_URLS: "http://0.0.0.0:50054"
    depends_on: [ read-db, storage ]
    expose: [ "50054" ]
    restart: unless-stopped

  query:
    image: ghcr.io/{{ github_owner | lower }}/meteo-query:{{ image_tag | default('prod') }}
    env_file: [ ".env.prod" ]
    depends_on: [ read-db, projection ]
    restart: unless-stopped
  
  edge:
    image: caddy:2
    depends_on: [ query ]
    ports:
      - "80:80"
      - "443:443"
    blkio_config:
      device_read_bps:
        - path: /dev/sda     # Root-Disk deines Hosts
          rate: "20mb"       # z.B. 20 MB/s (anpassen)
      device_read_iops:
        - path: /dev/sda
          rate: 800          # optional
    volumes:
      - /opt/meteo/caddy:/etc/caddy:ro
      - caddy_data:/data          # Cert-Storage
      - caddy_config:/config
    restart: unless-stopped

  station:
    image: ghcr.io/{{ github_owner | lower }}/meteo-station:{{ image_tag | default('prod') }}
    env_file: [ ".env.prod" ]
    depends_on: [ ingest ]
    blkio_config:
      device_read_bps:
        - path: /dev/sda     # Root-Disk deines Hosts
          rate: "20mb"       # z.B. 20 MB/s (anpassen)
      device_read_iops:
        - path: /dev/sda
          rate: 800          # optional
    volumes:
      - station_data:/data
    restart: unless-stopped

volumes:
  read_db_data: {}
  storage_db_data: {}
  station_data: {}
  caddy_data: {}
  caddy_config: {}
